<!DOCTYPE html>
<html>
<head lang="en">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="/js/jquery-1.12.4.js"></script>
    <script type="text/javascript" src="/js/bootstrap.js" ></script>
    <script type="text/javascript" src="/layui/layui.js"></script>
    <link href="/js/fileinput/css/fileinput.css" type="text/css" rel="stylesheet" />
    <script src="/js/fileinput/js/fileinput.min.js"></script>
    <script src="/js/fileinput/js/fileinput_locale_zh.js"></script>
    <link rel="stylesheet" href="/layui/css/layui.css"    media="all">
    <link rel="stylesheet" href="/css/total.css"    media="all">
    <link  rel="stylesheet" type="text/css" href="/css/bootstrap.css"></link>
    <link  rel="stylesheet" type="text/css" href="/css/style.css"></link>
    <title>学生信息</title>
</head>
<body>
<div class="container">
    <h1 class="text-center" style="padding: 20px">学生信息</h1>

    <form class="form-horizontal" id="formData">
        <div class="form-group">
            <label for="stuno" class="col-sm-2 control-label"><span style="color: red">*</span>学号</label>
            <div class="col-sm-8">
                <input name="stuno" type="text" class="form-control" id="stuno" readonly>
            </div>
        </div>
        <div class="form-group">
            <label for="stuname" class="col-sm-2 control-label"><span style="color: red">*</span>姓名</label>
            <div class="col-sm-8">
                <input name="stuname" type="text" class="form-control" id="stuname" placeholder="姓名" >
            </div>
        </div>
        <div class="form-group">
            <label for="password" class="col-sm-2 control-label"><span style="color: red">*</span>密码</label>
            <div class="col-sm-8">
                <input name="password" type="password" class="form-control" id="password" placeholder="Password">
            </div>
        </div>
<!--        <div class="form-group" >-->
<!--            <label for="password" class="col-sm-2 control-label"><span style="color: red">*</span>确认密码</label>-->
<!--            <div class="col-sm-8">-->
<!--                <input name="password2" type="password" class="form-control" id="password2" placeholder="Password" onblur="pwdIsEqual()">-->
<!--            </div>-->
<!--        </div>-->
        <div class="form-group">
            <label for="grade" class="col-sm-2 control-label"><span style="color: red">*</span>届数</label>
            <div class="col-sm-8">
                <input name="grade" type="text" class="form-control" id="grade" placeholder="2023">
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-2 control-label"><span style="color: red">*</span>性别</label>
            <div class="col-sm-8 radio">
                <label>
                    <input type="radio" name="sex" id="sex-female" value="1" checked>男
                </label>
                <label>
                    <input type="radio" name="sex" id="sex-male" value="0" >女
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="idNumber" class="col-sm-2 control-label"><span style="color: red">*</span>身份证号</label>
            <div class="col-sm-8">
                <input name="idNumber" type="text" class="form-control" id="idNumber" placeholder="Password">
            </div>
        </div>
        <div class="form-group">
            <label for="college" class="col-sm-2 control-label"><span style="color: red">*</span>学院</label>
            <div class="col-sm-8">
                <select class="form-control" name="college" id="college" onchange="loadMajor()">
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="major" class="col-sm-2 control-label"><span style="color: red">*</span>专业</label>
            <div class="col-sm-8">
                <select class="form-control" name="major" id="major">

                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="direction" class="col-sm-2 control-label">去向</label>
            <div class="col-sm-8">
                <select class="form-control" name="direction" id="direction" onchange="direction_change()">
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="place" class="col-sm-2 control-label">地址</label>
            <div class="col-sm-8">
                <input name="place" type="text" class="form-control" id="place" placeholder="xx单位">
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-2 control-label">是否省内</label>
            <div class="col-sm-8 radio">
                <label>
                    <input type="radio" name="isInProvince" id="inProvince" value="1" >是
                </label>
                <label>
                    <input type="radio" name="isInProvince" id="notInProvince" value="0" >否
                </label>
            </div>
        </div>
        <div id="enrollment">
            <div class="form-group">
                <label  class="col-sm-2 control-label">是否是双一流</label>
                <div class="col-sm-8 radio">
                    <label>
                        <input type="radio" name="isDFC" id="isDFC" value="1" >是
                    </label>
                    <label>
                        <input type="radio" name="isDFC" id="isNotDFC" value="0">否
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label  class="col-sm-2 control-label">是否跨考</label>
                <div class="col-sm-8 radio">
                    <label>
                        <input type="radio" name="isCrossExam" id="isCrossExam" value="1" >是
                    </label>
                    <label>
                        <input type="radio" name="isCrossExam" id="isNotCrossExam" value="0">否
                    </label>
                </div>
            </div>
        </div>
        <div id="work">
            <div class="form-group">
                <label for="college" class="col-sm-2 control-label">企业性质</label>
                <div class="col-sm-8">
                    <select class="form-control" name="companyId" id="companyType" >
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="url" class="col-sm-2 control-label">证明材料</label>
            <div class="col-sm-8">
                <img id="url" name="url">
            </div>
        </div>
        <div class="form-group">
            <label for="url" class="col-sm-2 control-label">最近修改时间</label>
            <div class="col-sm-8">
                <input type="text" class="form-control" id="lastSaveTime" readonly>
            </div>
        </div>

        <div class="form-group">
            <label for="note" class="col-sm-2 control-label">备注</label>
            <div class="col-sm-8">
                <input name="note" type="text" class="form-control" id="note"/>
            </div>
        </div>
        <div class="form-group">
                <button id="update" type="button" class="col-sm-offset-4 col-sm-1 btn btn-info">修改</button>
                <button id="back" type="button" class="col-sm-offset-1 col-sm-1 btn btn-danger">返回</button>
        </div>
    </form>
</div>
</body>
<script>
    var stuno, college, major, direction,url, companyId, isInProvince, isCrossExam,isDFC;
    $(document).keydown(function(event){
        if(event.keyCode==13){
            document.getElementById("update").click();
        }
    });
    function TimestampToDate(Timestamp) {
        let date1 = new Date(Timestamp);
        return date1.toLocaleDateString().replace(/\//g, "-") + " " + date1.toTimeString().substr(0, 8);
    }
    function direction_change(){
        let d=$("#direction").val();
        console.log(isInProvince+" "+ isCrossExam +" "+isDFC+" "+companyId);
        if(d==3){
            $("#enrollment").css("display", "inline");
            $("#work").css("display", "none");
            $('input[type=radio][name=isCrossExam][value='+isCrossExam+']').prop('checked', true);
            $('input[type=radio][name=isDFC][value='+isDFC+']').prop('checked', true);
        }else if(d==1 || d==2){
            $("#enrollment").css("display", "none");
            $("#work").css("display", "inline");
            $("#companyType").val(companyId);

        }else{
            $("#enrollment").css("display", "none");
            $("#work").css("display", "none");
        }

    }
    $(function (){
        stuno=sessionStorage["stuno"];
        console.log("stuno: "+stuno);
        $("#stuno").val(stuno);
        loadGraduate();


        $("#update").click(function (){
            if(!isValid())return;
            console.log($("#formData").serialize());
            $.ajax({
                type:"POST",
                url:"/graduate/"+stuno,
                data:$("#formData").serialize()+"&_method=PUT",
                dataType:"json",
                success:function (vo){
                    if(vo.code==200){
                        layer.alert('修改成功',{icon:1});
                        setTimeout(function () {
                            location.href=('/pages/manager/stuList.html');
                        }, 3000);
                    }else{
                        layer.alert('修改失败，请重试',{icon:2});
                        return ;
                    }
                }
            })
        });
        $("#back").click(function (){
            location.href=("/pages/manager/stuList.html");
        })

    })
    function loadGraduate() {
        $.ajax({
            type:"GET",
            url:"/graduate/"+stuno,
            data:null,
            dataType:"json",
            async:false,
            success:function (vo){
                let obj= vo.obj;
                college=obj.college;
                major=obj.major;
                direction=obj.direction;
                url=obj.url;
                isInProvince=obj.isInProvince==null?0:obj.isInProvince;
                isCrossExam =obj.isCrossExam==null?0:obj.isCrossExam;
                isDFC = obj.isDFC==null?0:obj.isDFC;
                companyId = obj.companyId==null?0:obj.companyId;
                loadCompanyType();
                loadCollege();
                loadDirection();
                $("input[name=stuno]").val(obj.stuno);
                $("input[name=grade]").val(obj.grade);
                $("input[name=password]").val(obj.password);
                $("input[name=stuname]").val(obj.stuname);
                $('input[type=radio][name=sex][value='+obj.sex+']').prop('checked', true);
                $("input[name=idNumber]").val(obj.idNumber);
                $("input[name=place]").val(obj.place);
                $('input[type=radio][name=isInProvince][value='+isInProvince+']').prop('checked', true);
                $("#lastSaveTime").val(TimestampToDate(obj.lastSaveTime));

                if(url!=null && url!=""){
                    $("#url").attr("src","/img/certificates/"+url);
                }else{
                    $("#url").addClass("hidden");
                    $("#url").parent().html("未上传材料");
                }
            }
        });
    }
    function isValid(){
        let stuno=$("#stuno").val();
        let stuname=$("#stuname").val();
        let password=$("#password").val();
        let grade=$("#grade").val();
        let sex=$("input:radio[name='sex']:checked").val();
        let idNumber=$("#idNumber").val();
        let college=$("#college").val();
        let major=$("#major").val();
        let direction = $("#direction").val();
        let url = $("#url").val();
        let note =$("#note").val();

        let stunoReg= /^20\d{10}$/;
        let idNumberReg=/^[0-9]{17}[0-9X]$/;
        let gradeReg=/^\d{4}$/;
        if(stuno=="" || stuno==null){
            layer.alert('请输入学号', {
                icon: 0,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        if(!stunoReg.test(stuno)){
            layer.alert('学号格式错误', {
                icon: 2,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        if(stuname=="" || stuname==null){
            layer.alert('请输入姓名', {
                icon: 0,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        if(password=="" || password==null){
            layer.alert('请输入密码', {
                icon: 0,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        // if(!pwdIsEqual())return ;
        if(grade=="" || grade==null || !gradeReg.test(grade)){
            layer.alert('届数格式不对', {
                icon: 0,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        console.log(sex);
        if(sex=="" || sex==null){
            layer.alert('请选择性别', {
                icon: 0,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        if(idNumber=="" || idNumber==null){
            layer.alert('请输入身份证号', {
                icon: 0,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        if(!idNumberReg.test(idNumber)){
            layer.alert('身份证号有误，请检查', {
                icon: 2,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        console.log(college);
        if(college==null || college=="0"){
            layer.alert('请选择学院', {
                icon: 0,
                skin: 'layer-ext-demo',
            });
            return false;
        }
        return true;
    }
    function loadMajor(){
        console.log("major"+major);
        $.ajax({
            type: "GET",
            url: "/major/all",
            data: null,
            dataType:"json",
            success: function(vo){
                let list=vo.list;
                let str="";
                for(let i=0;i<list.length;i++){
                    if($("#college").val()!=list[i].collegeid)continue;
                    str+='<option value="'+list[i].id+'">'+list[i].major+'</option>';
                }
                $("#major").html(str);
                $("#major").val(major);
            }
        });
    }
    function loadCollege(){
        console.log("college"+college);
        $.ajax({
            type: "GET",
            url: "/college/all",
            data: null,
            dataType:"json",
            success: function(vo){
                let list=vo.list;
                let str="";
                for(let i=0;i<list.length;i++){
                    str+='<option value="'+list[i].id+'">'+list[i].college+'</option>';
                }
                $("#college").html(str);
                $("#college").val(college);
                loadMajor();
            }
        });
    }
    function loadDirection(){
        console.log("direction:" + direction);
        $.ajax({
            type: "GET",
            url: "/direction/all",
            data: null,
            dataType:"json",
            success: function(vo){
                let list=vo.list;
                let str="";
                for(let i=0;i<list.length;i++){
                    str+='<option value="'+list[i].id+'">'+list[i].direction+'</option>';
                }
                $("#direction").html(str);
                if(direction==null)direction=0;
                $("#direction").val(direction);
                direction_change();

                //填充分页数据
            }
        });
    }
    function loadCompanyType(){
        $.ajax({
            type: "GET",
            url: "/companytype/all",
            data: null,
            dataType:"json",
            async:false,
            success: function(vo){
                let list=vo.list;
                let str="";
                str+='<option value="0" selected>请选择企业性质</option>';
                for(let i=0;i<list.length;i++){
                    str+='<option value="'+list[i].id+'">'+list[i].companyType+'</option>';
                }
                $("#companyType").html(str);
            }
        });
    }
</script>
</html>